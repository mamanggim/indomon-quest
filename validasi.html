<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Validasi Data</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center">

  <div class="max-w-md w-full bg-gray-800 rounded-2xl shadow-lg p-6 text-center">
    <h2 class="text-2xl font-bold mb-4">‚è≥ Memvalidasi Data...</h2>
    <p class="text-gray-400">Mohon tunggu sebentar, data kamu sedang diproses.</p>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, doc, setDoc, updateDoc, getDoc, increment, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // üîπ Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBVCCuIU6O_kwLIu18zFmLKx4nAZ15S5gU",
    authDomain: "indomon-quest.firebaseapp.com",
    projectId: "indomon-quest",
    storageBucket: "indomon-quest.firebasestorage.app",
    messagingSenderId: "483061706588",
    appId: "1:483061706588:web:ef2e02e7e8c2f08c12db99"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // üîπ Harga Pack
  const packPrices = {
    Free: 0,
    Gold: 10000,
    Platinum: 50000,
    Diamond: 100000
  };

  // üîπ Ambil param URL
  const urlParams = new URLSearchParams(window.location.search);
  const pack = urlParams.get("pack") || "Free";
  const refBy = urlParams.get("ref") || null; // angka referral number

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    try {
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);

      let myRefNumber = null;
      if (userSnap.exists()) {
        myRefNumber = userSnap.data().refNumber || null;
      }

      // üîπ Simpan / update data user
      await setDoc(userRef, {
        uid: user.uid,
        name: user.displayName || "Player",
        email: user.email,
        phone: user.phoneNumber || "Belum diisi",
        photo: user.photoURL || "https://i.pravatar.cc/100",
        pack: pack,
        reward: userSnap.exists() ? (userSnap.data().reward || 0) : 0,
        totalReferral: userSnap.exists() ? (userSnap.data().totalReferral || 0) : 0,
        referredBy: refBy ? parseInt(refBy) : null,
        updatedAt: serverTimestamp()
      }, { merge: true });

      // üîπ Cek referral ‚Üí pastikan bukan refer dirinya sendiri
      if (refBy && packPrices[pack] > 0 && String(myRefNumber) !== refBy) {
        const refMap = await getDoc(doc(db, "refNumber", refBy.toString()));
        if (refMap.exists()) {
          const refUid = refMap.data().uid;
          const rewardValue = Math.floor(packPrices[pack] * 0.1);

          await updateDoc(doc(db, "users", refUid), {
            reward: increment(rewardValue),
            totalReferral: increment(1)
          });
        }
      }

      // ‚úÖ Selesai ‚Üí redirect
      window.location.href = "dashboard.html";

    } catch (err) {
      console.error("Error saat validasi:", err);
      alert("Terjadi kesalahan saat validasi data!");
      window.location.href = "index.html";
    }
  });
  </script>
</body>
</html>
